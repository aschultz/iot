// 
// 
// 

#include "color.h"

#include <avr/io.h>
#include <avr/pgmspace.h>

#ifndef UINT16_MAX
#define UINT16_MAX 0xFFFFu
#endif

//
// Gamma lookup table. Massively cheaper than doing floating-point math on an ATMega without an FPU.
//
// https://learn.adafruit.com/led-tricks-gamma-correction/the-issue
// LED luminance (as perceived by human eye) is nonlinear.
// Make it appear linear by applying a gamma curve.
//
// Equivalent code:
//  float gamma = 4;
//  byte y; // Desired brightness
//  y = pow(x/255.0, gamma)*255 + 0.5;
//
// Maps an integer in the range [0, 2^InputDepth] to the range [0, 2^OutputDepth]
// on a curve with shape based on gamma
//

#if COLOR_DEPTH == 8
const static uint16_t gamma[256] PROGMEM = { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,3,4,4,5,6,7,8,10,11,13,14,16,18,21,23,26,29,32,36,40,44,48,53,58,64,69,76,82,89,97,105,113,122,132,142,152,164,175,188,201,215,229,244,260,277,294,312,331,351,372,394,417,440,465,490,517,545,574,604,635,667,701,736,772,809,848,888,929,972,1017,1063,1110,1159,1210,1262,1316,1372,1430,1489,1550,1613,1678,1744,1813,1884,1957,2032,2109,2188,2269,2353,2439,2527,2618,2711,2806,2904,3005,3108,3214,3322,3434,3548,3664,3784,3907,4032,4161,4292,4427,4565,4706,4850,4997,5148,5302,5460,5621,5786,5954,6126,6302,6481,6664,6851,7042,7237,7436,7639,7847,8058,8273,8493,8718,8946,9179,9417,9659,9906,10158,10414,10675,10941,11212,11488,11769,12055,12347,12643,12945,13252,13565,13883,14207,14537,14872,15213,15559,15912,16271,16635,17006,17383,17766,18155,18551,18953,19362,19777,20199,20627,21063,21505,21954,22410,22874,23344,23822,24307,24799,25299,25806,26321,26843,27373,27911,28457,29011,29573,30143,30721,31308,31903,32506,33118,33739,34368,35006,35652,36308,36973,37646,38329,39022,39723,40434,41154,41884,42624,43373,44133,44902,45681,46470,47270,48080,48900,49730,50571,51423,52285,53159,54043,54938,55844,56761,57690,58630,59581,60544,61519,62505,63503,64513,65535 };
#elif COLOR_DEPTH == 10
const static uint16_t gamma[1024] PROGMEM = { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,4,4,4,4,4,4,5,5,5,5,6,6,6,6,6,7,7,7,8,8,8,8,9,9,9,10,10,10,11,11,12,12,12,13,13,14,14,15,15,16,16,17,17,18,18,19,19,20,20,21,22,22,23,24,24,25,26,26,27,28,29,29,30,31,32,33,34,35,35,36,37,38,39,40,41,42,43,44,45,47,48,49,50,51,52,54,55,56,57,59,60,61,63,64,66,67,69,70,72,73,75,76,78,80,81,83,85,87,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,119,121,123,125,128,130,133,135,138,140,143,145,148,151,153,156,159,162,165,167,170,173,176,179,182,186,189,192,195,199,202,205,209,212,216,219,223,226,230,234,238,241,245,249,253,257,261,265,269,273,278,282,286,291,295,300,304,309,313,318,323,328,332,337,342,347,352,357,363,368,373,378,384,389,395,400,406,412,417,423,429,435,441,447,453,459,466,472,478,485,491,498,504,511,518,525,532,538,546,553,560,567,574,582,589,597,604,612,620,627,635,643,651,659,668,676,684,693,701,710,718,727,736,745,754,763,772,781,790,800,809,819,828,838,848,858,868,878,888,898,908,919,929,940,950,961,972,983,994,1005,1016,1028,1039,1050,1062,1074,1086,1097,1109,1121,1134,1146,1158,1171,1183,1196,1209,1222,1235,1248,1261,1274,1288,1301,1315,1328,1342,1356,1370,1384,1399,1413,1427,1442,1457,1471,1486,1501,1517,1532,1547,1563,1578,1594,1610,1626,1642,1658,1674,1691,1707,1724,1741,1758,1775,1792,1809,1827,1844,1862,1880,1898,1916,1934,1952,1971,1989,2008,2027,2046,2065,2084,2103,2123,2143,2162,2182,2202,2222,2243,2263,2284,2305,2325,2346,2368,2389,2410,2432,2454,2476,2498,2520,2542,2565,2587,2610,2633,2656,2679,2703,2726,2750,2774,2798,2822,2846,2870,2895,2920,2945,2970,2995,3021,3046,3072,3098,3124,3150,3176,3203,3230,3257,3284,3311,3338,3366,3394,3421,3449,3478,3506,3535,3564,3592,3622,3651,3680,3710,3740,3770,3800,3830,3861,3892,3923,3954,3985,4016,4048,4080,4112,4144,4177,4209,4242,4275,4308,4342,4375,4409,4443,4477,4511,4546,4581,4615,4651,4686,4721,4757,4793,4829,4866,4902,4939,4976,5013,5050,5088,5126,5164,5202,5240,5279,5318,5357,5396,5436,5475,5515,5556,5596,5637,5677,5718,5760,5801,5843,5885,5927,5969,6012,6055,6098,6141,6184,6228,6272,6316,6361,6406,6450,6496,6541,6587,6632,6679,6725,6771,6818,6865,6913,6960,7008,7056,7104,7153,7202,7251,7300,7349,7399,7449,7500,7550,7601,7652,7703,7755,7807,7859,7911,7964,8017,8070,8123,8177,8231,8285,8339,8394,8449,8504,8560,8616,8672,8728,8785,8842,8899,8956,9014,9072,9130,9189,9248,9307,9366,9426,9486,9546,9607,9668,9729,9790,9852,9914,9976,10039,10102,10165,10229,10292,10356,10421,10485,10550,10616,10681,10747,10813,10880,10947,11014,11081,11149,11217,11285,11354,11423,11492,11562,11632,11702,11772,11843,11915,11986,12058,12130,12202,12275,12348,12422,12496,12570,12644,12719,12794,12869,12945,13021,13098,13174,13252,13329,13407,13485,13563,13642,13721,13801,13881,13961,14041,14122,14203,14285,14367,14449,14532,14615,14698,14782,14866,14950,15035,15120,15206,15291,15378,15464,15551,15638,15726,15814,15903,15991,16081,16170,16260,16350,16441,16532,16623,16715,16807,16900,16993,17086,17180,17274,17368,17463,17558,17654,17750,17846,17943,18040,18138,18236,18334,18433,18532,18632,18732,18832,18933,19034,19136,19238,19340,19443,19546,19650,19754,19858,19963,20068,20174,20280,20387,20494,20601,20709,20817,20926,21035,21144,21254,21364,21475,21586,21698,21810,21922,22035,22149,22263,22377,22491,22607,22722,22838,22955,23071,23189,23307,23425,23544,23663,23782,23902,24023,24144,24265,24387,24509,24632,24755,24879,25003,25128,25253,25378,25504,25631,25758,25885,26013,26142,26271,26400,26530,26660,26791,26922,27054,27186,27319,27452,27585,27720,27854,27989,28125,28261,28398,28535,28672,28810,28949,29088,29228,29368,29508,29650,29791,29933,30076,30219,30363,30507,30652,30797,30942,31089,31235,31383,31530,31679,31827,31977,32127,32277,32428,32579,32731,32884,33037,33191,33345,33499,33654,33810,33966,34123,34281,34438,34597,34756,34915,35075,35236,35397,35559,35721,35884,36047,36211,36376,36541,36707,36873,37040,37207,37375,37543,37712,37882,38052,38223,38394,38566,38738,38911,39085,39259,39434,39609,39785,39962,40139,40317,40495,40674,40853,41033,41214,41395,41577,41760,41943,42126,42310,42495,42681,42867,43054,43241,43429,43617,43806,43996,44187,44377,44569,44761,44954,45148,45342,45536,45732,45928,46124,46321,46519,46718,46917,47117,47317,47518,47720,47922,48125,48329,48533,48738,48943,49149,49356,49564,49772,49981,50190,50400,50611,50822,51035,51247,51461,51675,51890,52105,52321,52538,52755,52973,53192,53412,53632,53853,54074,54296,54519,54743,54967,55192,55417,55644,55871,56098,56327,56556,56786,57016,57247,57479,57712,57945,58179,58414,58649,58885,59122,59360,59598,59837,60077,60317,60558,60800,61043,61286,61530,61775,62021,62267,62514,62761,63010,63259,63509,63760,64011,64263,64516,64770,65024,65279,65535 };
#elif COLOR_DEPTH == 12
const static uint16_t gamma[4096] PROGMEM = { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,19,19,19,19,19,19,19,20,20,20,20,20,20,20,21,21,21,21,21,21,21,22,22,22,22,22,22,23,23,23,23,23,23,24,24,24,24,24,24,25,25,25,25,25,25,26,26,26,26,26,27,27,27,27,27,27,28,28,28,28,28,29,29,29,29,29,30,30,30,30,30,31,31,31,31,31,32,32,32,32,32,33,33,33,33,34,34,34,34,34,35,35,35,35,36,36,36,36,36,37,37,37,37,38,38,38,38,39,39,39,39,40,40,40,40,41,41,41,41,42,42,42,42,43,43,43,43,44,44,44,44,45,45,45,46,46,46,46,47,47,47,48,48,48,48,49,49,49,50,50,50,50,51,51,51,52,52,52,53,53,53,53,54,54,54,55,55,55,56,56,56,57,57,57,58,58,58,59,59,59,60,60,60,61,61,61,62,62,62,63,63,63,64,64,64,65,65,65,66,66,67,67,67,68,68,68,69,69,70,70,70,71,71,71,72,72,73,73,73,74,74,75,75,75,76,76,77,77,77,78,78,79,79,79,80,80,81,81,82,82,82,83,83,84,84,85,85,85,86,86,87,87,88,88,88,89,89,90,90,91,91,92,92,93,93,94,94,95,95,95,96,96,97,97,98,98,99,99,100,100,101,101,102,102,103,103,104,104,105,105,106,106,107,107,108,108,109,110,110,111,111,112,112,113,113,114,114,115,115,116,117,117,118,118,119,119,120,121,121,122,122,123,123,124,125,125,126,126,127,127,128,129,129,130,130,131,132,132,133,134,134,135,135,136,137,137,138,138,139,140,140,141,142,142,143,144,144,145,146,146,147,148,148,149,150,150,151,152,152,153,154,154,155,156,156,157,158,158,159,160,161,161,162,163,163,164,165,166,166,167,168,168,169,170,171,171,172,173,174,174,175,176,177,177,178,179,180,180,181,182,183,184,184,185,186,187,187,188,189,190,191,191,192,193,194,195,195,196,197,198,199,200,200,201,202,203,204,205,205,206,207,208,209,210,211,211,212,213,214,215,216,217,218,218,219,220,221,222,223,224,225,226,227,228,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,287,288,289,290,291,292,293,294,295,296,298,299,300,301,302,303,304,305,307,308,309,310,311,312,314,315,316,317,318,319,321,322,323,324,325,327,328,329,330,331,333,334,335,336,338,339,340,341,342,344,345,346,347,349,350,351,353,354,355,356,358,359,360,362,363,364,365,367,368,369,371,372,373,375,376,377,379,380,381,383,384,385,387,388,389,391,392,394,395,396,398,399,401,402,403,405,406,408,409,410,412,413,415,416,418,419,421,422,423,425,426,428,429,431,432,434,435,437,438,440,441,443,444,446,447,449,450,452,453,455,456,458,460,461,463,464,466,467,469,471,472,474,475,477,478,480,482,483,485,486,488,490,491,493,495,496,498,500,501,503,505,506,508,510,511,513,515,516,518,520,521,523,525,527,528,530,532,533,535,537,539,540,542,544,546,547,549,551,553,555,556,558,560,562,564,565,567,569,571,573,574,576,578,580,582,584,586,587,589,591,593,595,597,599,601,602,604,606,608,610,612,614,616,618,620,622,624,626,628,630,631,633,635,637,639,641,643,645,647,649,651,653,655,657,660,662,664,666,668,670,672,674,676,678,680,682,684,686,688,691,693,695,697,699,701,703,705,708,710,712,714,716,718,720,723,725,727,729,731,734,736,738,740,742,745,747,749,751,754,756,758,760,763,765,767,770,772,774,776,779,781,783,786,788,790,793,795,797,800,802,804,807,809,811,814,816,819,821,823,826,828,831,833,835,838,840,843,845,848,850,853,855,858,860,863,865,867,870,873,875,878,880,883,885,888,890,893,895,898,900,903,906,908,911,913,916,919,921,924,926,929,932,934,937,940,942,945,948,950,953,956,958,961,964,966,969,972,975,977,980,983,985,988,991,994,997,999,1002,1005,1008,1010,1013,1016,1019,1022,1025,1027,1030,1033,1036,1039,1042,1045,1047,1050,1053,1056,1059,1062,1065,1068,1071,1074,1076,1079,1082,1085,1088,1091,1094,1097,1100,1103,1106,1109,1112,1115,1118,1121,1124,1127,1130,1133,1136,1139,1143,1146,1149,1152,1155,1158,1161,1164,1167,1170,1174,1177,1180,1183,1186,1189,1192,1196,1199,1202,1205,1208,1212,1215,1218,1221,1225,1228,1231,1234,1237,1241,1244,1247,1251,1254,1257,1260,1264,1267,1270,1274,1277,1280,1284,1287,1291,1294,1297,1301,1304,1307,1311,1314,1318,1321,1324,1328,1331,1335,1338,1342,1345,1349,1352,1356,1359,1363,1366,1370,1373,1377,1380,1384,1387,1391,1394,1398,1402,1405,1409,1412,1416,1420,1423,1427,1430,1434,1438,1441,1445,1449,1452,1456,1460,1463,1467,1471,1475,1478,1482,1486,1490,1493,1497,1501,1505,1508,1512,1516,1520,1524,1527,1531,1535,1539,1543,1547,1550,1554,1558,1562,1566,1570,1574,1578,1582,1585,1589,1593,1597,1601,1605,1609,1613,1617,1621,1625,1629,1633,1637,1641,1645,1649,1653,1657,1661,1665,1670,1674,1678,1682,1686,1690,1694,1698,1702,1707,1711,1715,1719,1723,1727,1732,1736,1740,1744,1748,1753,1757,1761,1765,1770,1774,1778,1782,1787,1791,1795,1800,1804,1808,1813,1817,1821,1826,1830,1834,1839,1843,1848,1852,1856,1861,1865,1870,1874,1879,1883,1888,1892,1897,1901,1906,1910,1915,1919,1924,1928,1933,1937,1942,1946,1951,1956,1960,1965,1969,1974,1979,1983,1988,1993,1997,2002,2007,2011,2016,2021,2026,2030,2035,2040,2044,2049,2054,2059,2064,2068,2073,2078,2083,2088,2092,2097,2102,2107,2112,2117,2122,2126,2131,2136,2141,2146,2151,2156,2161,2166,2171,2176,2181,2186,2191,2196,2201,2206,2211,2216,2221,2226,2231,2236,2241,2246,2251,2257,2262,2267,2272,2277,2282,2287,2293,2298,2303,2308,2313,2319,2324,2329,2334,2340,2345,2350,2355,2361,2366,2371,2377,2382,2387,2393,2398,2403,2409,2414,2419,2425,2430,2436,2441,2447,2452,2457,2463,2468,2474,2479,2485,2490,2496,2501,2507,2512,2518,2524,2529,2535,2540,2546,2551,2557,2563,2568,2574,2580,2585,2591,2597,2602,2608,2614,2619,2625,2631,2637,2642,2648,2654,2660,2666,2671,2677,2683,2689,2695,2700,2706,2712,2718,2724,2730,2736,2742,2748,2754,2760,2765,2771,2777,2783,2789,2795,2801,2807,2813,2820,2826,2832,2838,2844,2850,2856,2862,2868,2874,2880,2887,2893,2899,2905,2911,2918,2924,2930,2936,2942,2949,2955,2961,2967,2974,2980,2986,2993,2999,3005,3012,3018,3024,3031,3037,3044,3050,3056,3063,3069,3076,3082,3089,3095,3102,3108,3115,3121,3128,3134,3141,3147,3154,3161,3167,3174,3180,3187,3194,3200,3207,3214,3220,3227,3234,3240,3247,3254,3260,3267,3274,3281,3288,3294,3301,3308,3315,3322,3328,3335,3342,3349,3356,3363,3370,3377,3384,3391,3397,3404,3411,3418,3425,3432,3439,3446,3453,3461,3468,3475,3482,3489,3496,3503,3510,3517,3524,3532,3539,3546,3553,3560,3567,3575,3582,3589,3596,3604,3611,3618,3626,3633,3640,3648,3655,3662,3670,3677,3684,3692,3699,3707,3714,3721,3729,3736,3744,3751,3759,3766,3774,3781,3789,3796,3804,3812,3819,3827,3834,3842,3850,3857,3865,3873,3880,3888,3896,3903,3911,3919,3927,3934,3942,3950,3958,3965,3973,3981,3989,3997,4005,4013,4020,4028,4036,4044,4052,4060,4068,4076,4084,4092,4100,4108,4116,4124,4132,4140,4148,4156,4164,4172,4181,4189,4197,4205,4213,4221,4230,4238,4246,4254,4262,4271,4279,4287,4296,4304,4312,4320,4329,4337,4346,4354,4362,4371,4379,4387,4396,4404,4413,4421,4430,4438,4447,4455,4464,4472,4481,4489,4498,4507,4515,4524,4532,4541,4550,4558,4567,4576,4584,4593,4602,4611,4619,4628,4637,4646,4655,4663,4672,4681,4690,4699,4708,4717,4725,4734,4743,4752,4761,4770,4779,4788,4797,4806,4815,4824,4833,4842,4851,4860,4870,4879,4888,4897,4906,4915,4924,4934,4943,4952,4961,4971,4980,4989,4998,5008,5017,5026,5036,5045,5054,5064,5073,5082,5092,5101,5111,5120,5130,5139,5149,5158,5168,5177,5187,5196,5206,5215,5225,5235,5244,5254,5264,5273,5283,5293,5302,5312,5322,5332,5341,5351,5361,5371,5380,5390,5400,5410,5420,5430,5440,5450,5459,5469,5479,5489,5499,5509,5519,5529,5539,5549,5559,5569,5580,5590,5600,5610,5620,5630,5640,5651,5661,5671,5681,5691,5702,5712,5722,5732,5743,5753,5763,5774,5784,5794,5805,5815,5826,5836,5847,5857,5867,5878,5888,5899,5909,5920,5931,5941,5952,5962,5973,5984,5994,6005,6016,6026,6037,6048,6058,6069,6080,6091,6101,6112,6123,6134,6145,6156,6166,6177,6188,6199,6210,6221,6232,6243,6254,6265,6276,6287,6298,6309,6320,6331,6342,6353,6364,6376,6387,6398,6409,6420,6432,6443,6454,6465,6477,6488,6499,6510,6522,6533,6545,6556,6567,6579,6590,6602,6613,6625,6636,6647,6659,6671,6682,6694,6705,6717,6728,6740,6752,6763,6775,6787,6798,6810,6822,6834,6845,6857,6869,6881,6892,6904,6916,6928,6940,6952,6964,6976,6987,6999,7011,7023,7035,7047,7059,7071,7084,7096,7108,7120,7132,7144,7156,7168,7181,7193,7205,7217,7229,7242,7254,7266,7279,7291,7303,7316,7328,7340,7353,7365,7378,7390,7403,7415,7428,7440,7453,7465,7478,7490,7503,7515,7528,7541,7553,7566,7579,7591,7604,7617,7630,7642,7655,7668,7681,7694,7706,7719,7732,7745,7758,7771,7784,7797,7810,7823,7836,7849,7862,7875,7888,7901,7914,7927,7940,7954,7967,7980,7993,8006,8020,8033,8046,8059,8073,8086,8099,8113,8126,8139,8153,8166,8180,8193,8207,8220,8234,8247,8261,8274,8288,8301,8315,8329,8342,8356,8370,8383,8397,8411,8424,8438,8452,8466,8480,8493,8507,8521,8535,8549,8563,8577,8591,8604,8618,8632,8646,8660,8675,8689,8703,8717,8731,8745,8759,8773,8787,8802,8816,8830,8844,8859,8873,8887,8901,8916,8930,8945,8959,8973,8988,9002,9017,9031,9046,9060,9075,9089,9104,9118,9133,9147,9162,9177,9191,9206,9221,9235,9250,9265,9280,9295,9309,9324,9339,9354,9369,9384,9399,9413,9428,9443,9458,9473,9488,9503,9518,9534,9549,9564,9579,9594,9609,9624,9640,9655,9670,9685,9700,9716,9731,9746,9762,9777,9792,9808,9823,9839,9854,9870,9885,9901,9916,9932,9947,9963,9978,9994,10010,10025,10041,10057,10072,10088,10104,10120,10135,10151,10167,10183,10199,10214,10230,10246,10262,10278,10294,10310,10326,10342,10358,10374,10390,10406,10422,10439,10455,10471,10487,10503,10520,10536,10552,10568,10585,10601,10617,10634,10650,10666,10683,10699,10716,10732,10749,10765,10782,10798,10815,10831,10848,10865,10881,10898,10915,10931,10948,10965,10982,10998,11015,11032,11049,11066,11082,11099,11116,11133,11150,11167,11184,11201,11218,11235,11252,11269,11286,11304,11321,11338,11355,11372,11389,11407,11424,11441,11459,11476,11493,11511,11528,11545,11563,11580,11598,11615,11633,11650,11668,11685,11703,11720,11738,11756,11773,11791,11809,11826,11844,11862,11880,11897,11915,11933,11951,11969,11987,12005,12023,12041,12058,12076,12094,12113,12131,12149,12167,12185,12203,12221,12239,12258,12276,12294,12312,12331,12349,12367,12385,12404,12422,12441,12459,12477,12496,12514,12533,12551,12570,12589,12607,12626,12644,12663,12682,12700,12719,12738,12757,12775,12794,12813,12832,12851,12869,12888,12907,12926,12945,12964,12983,13002,13021,13040,13059,13078,13098,13117,13136,13155,13174,13194,13213,13232,13251,13271,13290,13309,13329,13348,13368,13387,13406,13426,13445,13465,13484,13504,13524,13543,13563,13583,13602,13622,13642,13661,13681,13701,13721,13741,13760,13780,13800,13820,13840,13860,13880,13900,13920,13940,13960,13980,14000,14020,14040,14061,14081,14101,14121,14142,14162,14182,14202,14223,14243,14264,14284,14304,14325,14345,14366,14386,14407,14427,14448,14469,14489,14510,14531,14551,14572,14593,14613,14634,14655,14676,14697,14718,14739,14759,14780,14801,14822,14843,14864,14885,14906,14928,14949,14970,14991,15012,15033,15055,15076,15097,15118,15140,15161,15182,15204,15225,15247,15268,15290,15311,15333,15354,15376,15397,15419,15441,15462,15484,15506,15527,15549,15571,15593,15615,15636,15658,15680,15702,15724,15746,15768,15790,15812,15834,15856,15878,15900,15922,15945,15967,15989,16011,16033,16056,16078,16100,16123,16145,16168,16190,16212,16235,16257,16280,16302,16325,16348,16370,16393,16415,16438,16461,16484,16506,16529,16552,16575,16597,16620,16643,16666,16689,16712,16735,16758,16781,16804,16827,16850,16873,16897,16920,16943,16966,16989,17013,17036,17059,17083,17106,17129,17153,17176,17200,17223,17247,17270,17294,17317,17341,17365,17388,17412,17436,17459,17483,17507,17531,17555,17578,17602,17626,17650,17674,17698,17722,17746,17770,17794,17818,17842,17866,17891,17915,17939,17963,17987,18012,18036,18060,18085,18109,18134,18158,18182,18207,18231,18256,18281,18305,18330,18354,18379,18404,18428,18453,18478,18503,18528,18552,18577,18602,18627,18652,18677,18702,18727,18752,18777,18802,18827,18852,18877,18903,18928,18953,18978,19004,19029,19054,19080,19105,19130,19156,19181,19207,19232,19258,19283,19309,19335,19360,19386,19412,19437,19463,19489,19515,19540,19566,19592,19618,19644,19670,19696,19722,19748,19774,19800,19826,19852,19878,19905,19931,19957,19983,20010,20036,20062,20088,20115,20141,20168,20194,20221,20247,20274,20300,20327,20354,20380,20407,20434,20460,20487,20514,20541,20567,20594,20621,20648,20675,20702,20729,20756,20783,20810,20837,20864,20891,20919,20946,20973,21000,21028,21055,21082,21110,21137,21164,21192,21219,21247,21274,21302,21329,21357,21385,21412,21440,21468,21495,21523,21551,21579,21607,21634,21662,21690,21718,21746,21774,21802,21830,21858,21886,21915,21943,21971,21999,22027,22056,22084,22112,22141,22169,22197,22226,22254,22283,22311,22340,22368,22397,22426,22454,22483,22512,22540,22569,22598,22627,22656,22685,22713,22742,22771,22800,22829,22858,22887,22917,22946,22975,23004,23033,23062,23092,23121,23150,23180,23209,23238,23268,23297,23327,23356,23386,23415,23445,23475,23504,23534,23564,23593,23623,23653,23683,23713,23743,23772,23802,23832,23862,23892,23922,23952,23983,24013,24043,24073,24103,24134,24164,24194,24224,24255,24285,24316,24346,24377,24407,24438,24468,24499,24529,24560,24591,24621,24652,24683,24714,24744,24775,24806,24837,24868,24899,24930,24961,24992,25023,25054,25085,25117,25148,25179,25210,25241,25273,25304,25336,25367,25398,25430,25461,25493,25524,25556,25588,25619,25651,25683,25714,25746,25778,25810,25841,25873,25905,25937,25969,26001,26033,26065,26097,26129,26161,26194,26226,26258,26290,26323,26355,26387,26420,26452,26484,26517,26549,26582,26614,26647,26680,26712,26745,26778,26810,26843,26876,26909,26942,26974,27007,27040,27073,27106,27139,27172,27205,27239,27272,27305,27338,27371,27405,27438,27471,27505,27538,27571,27605,27638,27672,27705,27739,27773,27806,27840,27874,27907,27941,27975,28009,28043,28077,28110,28144,28178,28212,28246,28280,28315,28349,28383,28417,28451,28486,28520,28554,28588,28623,28657,28692,28726,28761,28795,28830,28864,28899,28934,28968,29003,29038,29073,29107,29142,29177,29212,29247,29282,29317,29352,29387,29422,29457,29492,29528,29563,29598,29633,29669,29704,29739,29775,29810,29846,29881,29917,29952,29988,30024,30059,30095,30131,30166,30202,30238,30274,30310,30346,30382,30418,30454,30490,30526,30562,30598,30634,30670,30707,30743,30779,30815,30852,30888,30925,30961,30998,31034,31071,31107,31144,31181,31217,31254,31291,31328,31364,31401,31438,31475,31512,31549,31586,31623,31660,31697,31734,31771,31809,31846,31883,31921,31958,31995,32033,32070,32108,32145,32183,32220,32258,32295,32333,32371,32408,32446,32484,32522,32560,32598,32636,32674,32712,32750,32788,32826,32864,32902,32940,32978,33017,33055,33093,33132,33170,33209,33247,33286,33324,33363,33401,33440,33478,33517,33556,33595,33633,33672,33711,33750,33789,33828,33867,33906,33945,33984,34023,34062,34102,34141,34180,34220,34259,34298,34338,34377,34417,34456,34496,34535,34575,34614,34654,34694,34734,34773,34813,34853,34893,34933,34973,35013,35053,35093,35133,35173,35213,35253,35294,35334,35374,35414,35455,35495,35536,35576,35617,35657,35698,35738,35779,35820,35860,35901,35942,35983,36024,36064,36105,36146,36187,36228,36269,36310,36352,36393,36434,36475,36516,36558,36599,36640,36682,36723,36765,36806,36848,36889,36931,36973,37014,37056,37098,37140,37182,37223,37265,37307,37349,37391,37433,37475,37517,37560,37602,37644,37686,37729,37771,37813,37856,37898,37941,37983,38026,38068,38111,38153,38196,38239,38282,38324,38367,38410,38453,38496,38539,38582,38625,38668,38711,38754,38797,38841,38884,38927,38971,39014,39057,39101,39144,39188,39231,39275,39318,39362,39406,39450,39493,39537,39581,39625,39669,39713,39757,39801,39845,39889,39933,39977,40021,40066,40110,40154,40199,40243,40287,40332,40376,40421,40465,40510,40555,40599,40644,40689,40734,40778,40823,40868,40913,40958,41003,41048,41093,41138,41184,41229,41274,41319,41365,41410,41455,41501,41546,41592,41637,41683,41728,41774,41820,41866,41911,41957,42003,42049,42095,42141,42187,42233,42279,42325,42371,42417,42463,42510,42556,42602,42649,42695,42741,42788,42834,42881,42928,42974,43021,43068,43114,43161,43208,43255,43302,43349,43396,43443,43490,43537,43584,43631,43678,43725,43773,43820,43867,43915,43962,44010,44057,44105,44152,44200,44248,44295,44343,44391,44439,44486,44534,44582,44630,44678,44726,44774,44823,44871,44919,44967,45015,45064,45112,45160,45209,45257,45306,45354,45403,45452,45500,45549,45598,45647,45695,45744,45793,45842,45891,45940,45989,46038,46087,46137,46186,46235,46284,46334,46383,46433,46482,46531,46581,46631,46680,46730,46780,46829,46879,46929,46979,47029,47079,47129,47179,47229,47279,47329,47379,47429,47479,47530,47580,47630,47681,47731,47782,47832,47883,47933,47984,48035,48086,48136,48187,48238,48289,48340,48391,48442,48493,48544,48595,48646,48697,48749,48800,48851,48903,48954,49006,49057,49109,49160,49212,49263,49315,49367,49419,49471,49522,49574,49626,49678,49730,49782,49834,49887,49939,49991,50043,50096,50148,50200,50253,50305,50358,50410,50463,50516,50568,50621,50674,50727,50779,50832,50885,50938,50991,51044,51097,51150,51204,51257,51310,51363,51417,51470,51524,51577,51631,51684,51738,51791,51845,51899,51952,52006,52060,52114,52168,52222,52276,52330,52384,52438,52492,52547,52601,52655,52710,52764,52818,52873,52927,52982,53036,53091,53146,53201,53255,53310,53365,53420,53475,53530,53585,53640,53695,53750,53805,53861,53916,53971,54026,54082,54137,54193,54248,54304,54360,54415,54471,54527,54582,54638,54694,54750,54806,54862,54918,54974,55030,55086,55143,55199,55255,55312,55368,55424,55481,55537,55594,55651,55707,55764,55821,55877,55934,55991,56048,56105,56162,56219,56276,56333,56390,56448,56505,56562,56620,56677,56734,56792,56849,56907,56965,57022,57080,57138,57195,57253,57311,57369,57427,57485,57543,57601,57659,57717,57776,57834,57892,57951,58009,58067,58126,58184,58243,58302,58360,58419,58478,58536,58595,58654,58713,58772,58831,58890,58949,59008,59068,59127,59186,59245,59305,59364,59424,59483,59543,59602,59662,59722,59781,59841,59901,59961,60021,60081,60141,60201,60261,60321,60381,60441,60502,60562,60622,60683,60743,60804,60864,60925,60985,61046,61107,61168,61228,61289,61350,61411,61472,61533,61594,61655,61716,61778,61839,61900,61962,62023,62084,62146,62208,62269,62331,62392,62454,62516,62578,62640,62701,62763,62825,62887,62950,63012,63074,63136,63198,63261,63323,63385,63448,63510,63573,63636,63698,63761,63824,63886,63949,64012,64075,64138,64201,64264,64327,64390,64454,64517,64580,64643,64707,64770,64834,64897,64961,65024,65088,65152,65216,65279,65343,65407,65471,65535 };
#endif

/*
Value [0, 255]
Returns a number in the range [0, 255]
*/
uint8_t applyGamma(uint8_t value)
{
    return pgm_read_byte(&gamma[value]);
}

/*
    Value [0, 4096]
    Returns a number in the range [0, 65535]
*/
uint16_t applyGamma(uint16_t value)
{
	return pgm_read_word(&gamma[value]);
}




/*
    h -- Hue.           [0, 1024]   Color
    s -- Saturation.    [0, 65535]  Colorfulness
    v -- Value.         [0, 65535]  Brightness
*/
void hsvToRgb16(
    uint16_t h, uint16_t s, uint16_t v,
    uint16_t &r, uint16_t &g, uint16_t &b)
{
    if (s == 0) {
        r = g = b = 0;
        return;
    }

    //
    //        V -------------------------
    //             /\      /\      /\
    //            /  \    /  \    /  \
    //           /    \  /    \  /    \
    //          /      \/      \/      \
    //  V*(1-S) -------------------------
    //       H  0      120     240     360
    //
    // V and S set the maximum and minimum values of the color channels.
    // H selects which color channel maps to max, min, or slope.
    //
    // For example, at H=30, R=max, G=slope, B=min
    //

    uint16_t max = v;

    // 
    // min = v * (1 - s)
    // 
    // This equation assumes normalized values (range of [0,1]).
    // We want to use integers, not floats, so we need to rescale
    // based on our bitdepth.
    // 
    // uint8_t min = v * (UINT8_MAX - s) / UINT8_MAX;
    // uint16_t min = v * (UINT16_MAX - s) / UINT16_MAX;
    // 
    // We want to avoid the division operator since 
    // its expensive. We can use bitshift as division, but
    // only for powers of 2, so we have to correct for the difference.
    //
    // We can also leverage 2's complement on the subtraction
    // (UINT*_MAX - s) == ~s
    //
    uint32_t numerator = v * (uint16_t)(~s);
    uint16_t min = (numerator + (numerator >> 16) + 1) >> 16;

    //
    // slopeDown = v * (1 - s * h)
    // slopeUp   = v * (1 - s * (1 - h))
    //
    //  v*(1-s*(0+h)) = v*(1-0s-sh) = v - 0vs - vsh
    //  v*(1-s*(1-h)) = v*(1-1s+sh) = v - 1vs + vsh
    //
    // uint16_t slopeDown = 

    uint16_t slopeDown;
    uint16_t slopeUp;


}

void hsvToRgb(uint8_t h, uint8_t s, uint8_t v, uint8_t rgb[3])
{
	int r, g, b;

	if (s == 0)
	{
		// Shortcut for grayscale
		r = g = b = v;
	}
	else
	{
        // h = [0,360]; s = [0,1]; v = [0,1]
        // Equations expect float (including modulus)
        //
		// c = v*s
		// h' = h/60
		//
		// x = v - c                    = v - v*s            = v*(1-s)
		// y = c + v - c                = v                  = v
		// z = c - c*|h'mod2-1| + v - c = v - v*s*|h'mod2-1| = v*(1-s*|h'mod2-1|)

		// http://forum.arduino.cc/index.php/topic,40601.0.html
        // http://www.vagrearg.org/content/hsvrgb

		uint8_t sector = h / 60U; // [0,5]
		uint8_t remainder = (h - sector * 60U) * 64U / 15U;
		uint8_t p = v * (255U - s) / 255U;
		uint8_t q = v * (255UL * 255UL - ((long)s)*remainder) / (255UL * 255UL);
		uint8_t t = v * (255UL * 255UL - ((long)s)*(255U - remainder)) / (255UL * 255UL);
        
		switch (sector)
		{
		case 0:
			r = v;
			g = t;
			b = p;
			break;

		case 1:
			r = q;
			g = v;
			b = p;
			break;

		case 2:
			r = p;
			g = v;
			b = t;
			break;

		case 3:
			r = p;
			g = q;
			b = v;
			break;

		case 4:
			r = t;
			g = p;
			b = v;
			break;

		case 5:
			r = v;
			g = p;
			b = q;
			break;
		}
	}
	rgb[0] = r;
	rgb[1] = g;
	rgb[2] = b;
}

